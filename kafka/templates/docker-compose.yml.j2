name: {{ general_vars.project_name }}
services:
  # Kafka broker service
  kafka1:
    restart: always
    container_name: kafka1
    image: confluentinc/cp-kafka:7.8.0
    ports:
      - "9092:9092"
    environment:
      CLUSTER_ID: "6pKOGDCjRJumCIzamlDnig"
      KAFKA_NODE_ID: 1
      KAFKA_BROKER_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "INTERNAL:SSL,CLIENT:SASL_SSL,CONTROLLER:SSL"
      KAFKA_LISTENERS: "INTERNAL://:9090,CLIENT://:9092,CONTROLLER://kafka1:9093"
      KAFKA_ADVERTISED_LISTENERS: "INTERNAL://kafka1:9090,CLIENT://{{ general_vars.machine_url }}:9092"
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka1:9093"
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_PROCESS_ROLES: "controller,broker"

      # SSL Configuration for INTERNAL and CONTROLLER
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/kafka.keystore.jks
      KAFKA_SSL_KEYSTORE_PASSWORD: {{ general_vars.generic_psw }}
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka.truststore.jks
      KAFKA_SSL_TRUSTSTORE_PASSWORD: {{ general_vars.generic_psw }}
      KAFKA_SSL_KEY_PASSWORD: {{ general_vars.generic_psw }}
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""

      # SASL config
      KAFKA_SASL_ENABLED_MECHANISMS: PLAIN
      KAFKA_LISTENER_NAME_CLIENT_SASL_ENABLED_MECHANISMS: PLAIN
      KAFKA_LISTENER_NAME_CLIENT_PLAIN_SASL_JAAS_CONFIG: 'org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="{{ general_vars.generic_psw }}" user_{{ kafka_cred.kafka_user }}="{{ kafka_cred.kafka_psw }}";'

      # SSL Configuration for CLIENT listener
      KAFKA_LISTENER_NAME_CLIENT_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/kafka.keystore.jks
      KAFKA_LISTENER_NAME_CLIENT_SSL_KEYSTORE_PASSWORD: {{ general_vars.generic_psw }}
      KAFKA_LISTENER_NAME_CLIENT_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka.truststore.jks
      KAFKA_LISTENER_NAME_CLIENT_SSL_TRUSTSTORE_PASSWORD: {{ general_vars.generic_psw }}
      KAFKA_LISTENER_NAME_CLIENT_SSL_KEY_PASSWORD: {{ general_vars.generic_psw }}

      # Message size limits
      KAFKA_MESSAGE_MAX_BYTES: 200000000
      KAFKA_REPLICA_FETCH_MAX_BYTES: 200000000
      KAFKA_FETCH_MESSAGE_MAX_BYTES: 200000000

      # Connection settings
      KAFKA_CONNECTIONS_MAX_IDLE_MS: 3000000000

      # Replication factor
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "kafka-topics --list --bootstrap-server {{ general_vars.machine_url }}:9092 --command-config /etc/kafka/client.config  || exit 1",
        ]
      start_period: 30s
      interval: 10s
      timeout: 10s
      retries: 10

    volumes:
      - "{{ general_vars.digital_twin_folder }}/certificates/keystore.jks:/etc/kafka/secrets/kafka.keystore.jks:ro"
      - "{{ general_vars.digital_twin_folder }}/certificates/truststore.jks:/etc/kafka/secrets/kafka.truststore.jks:ro"
      - "{{ general_vars.digital_twin_folder }}/certificates/ca.der:/usr/local/share/ca-certificates/csc.der:ro"
      - "./client.config:/etc/kafka/client.config:ro"
      - "kafka-data1:/var/lib/kafka/data"
    networks:
      - services-network

  # Schema Registry service
  schema-registry:
    image: confluentinc/cp-schema-registry:7.0.1
    hostname: schema-registry
    container_name: schema-registry
    depends_on:
      kafka1:
        condition: service_healthy
    ports:
      - "8081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: "kafka1:9090"
      SCHEMA_REGISTRY_KAFKASTORE_SECURITY_PROTOCOL: SSL
      SCHEMA_REGISTRY_KAFKASTORE_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""
      SCHEMA_REGISTRY_KAFKASTORE_SSL_KEY_PASSWORD: "{{ general_vars.generic_psw }}"
      SCHEMA_REGISTRY_KAFKASTORE_SSL_KEYSTORE_LOCATION: "/bitnami/kafka/config/certs/kafka.keystore.jks"
      SCHEMA_REGISTRY_KAFKASTORE_SSL_KEYSTORE_PASSWORD: "{{ general_vars.generic_psw }}"
      SCHEMA_REGISTRY_KAFKASTORE_SSL_TRUSTSTORE_LOCATION: "/bitnami/kafka/config/certs/kafka.truststore.jks"
      SCHEMA_REGISTRY_KAFKASTORE_SSL_TRUSTSTORE_PASSWORD: "{{ general_vars.generic_psw }}"
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
    volumes:
      - "{{ general_vars.digital_twin_folder }}/certificates/keystore.jks:/bitnami/kafka/config/certs/kafka.keystore.jks:rw"
      - "{{ general_vars.digital_twin_folder }}/certificates/truststore.jks:/bitnami/kafka/config/certs/kafka.truststore.jks:rw"
    networks:
      - services-network

  # ksqlDB Server service
  ksqldb-server:
    image: confluentinc/cp-ksqldb-server:7.0.1
    hostname: ksqldb-server
    container_name: ksqldb-server
    depends_on:
      kafka1:
        condition: service_healthy
    ports:
      - "8088:8088"
    environment:
      KSQL_CONFIG_DIR: "/etc/ksql"
      KSQL_BOOTSTRAP_SERVERS: "kafka1:9090"
      KSQL_HOST_NAME: ksqldb-server
      KSQL_LISTENERS: "http://0.0.0.0:8088"
      KSQL_CACHE_MAX_BYTES_BUFFERING: 0
      KSQL_PRODUCER_INTERCEPTOR_CLASSES: "io.confluent.monitoring.clients.interceptor.MonitoringProducerInterceptor"
      KSQL_CONSUMER_INTERCEPTOR_CLASSES: "io.confluent.monitoring.clients.interceptor.MonitoringConsumerInterceptor"
      KSQL_KSQL_LOGGING_PROCESSING_TOPIC_REPLICATION_FACTOR: 1
      KSQL_KSQL_LOGGING_PROCESSING_TOPIC_AUTO_CREATE: "true"
      KSQL_KSQL_LOGGING_PROCESSING_STREAM_AUTO_CREATE: "true"
      KSQL_SECURITY_PROTOCOL: "SSL"
      KSQL_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""
      KSQL_SSL_TRUSTSTORE_LOCATION: "/etc/ksql/secrets/kafka.client.truststore.jks"
      KSQL_SSL_TRUSTSTORE_PASSWORD: "{{ general_vars.generic_psw }}"
      KSQL_SSL_KEYSTORE_LOCATION: "/etc/ksql/secrets/kafka.client.keystore.jks"
      KSQL_SSL_KEYSTORE_PASSWORD: "{{ general_vars.generic_psw }}"
      KSQL_KSQL_SCHEMA_REGISTRY_URL: "http://schema-registry:8081"
    volumes:
      - "{{ general_vars.digital_twin_folder }}/certificates/keystore.jks:/etc/ksql/secrets/kafka.client.keystore.jks:ro"
      - "{{ general_vars.digital_twin_folder }}/certificates/truststore.jks:/etc/ksql/secrets/kafka.client.truststore.jks:ro"
    networks:
      - services-network

  # Kafka REST Proxy service
  rest-proxy:
    image: confluentinc/cp-kafka-rest:7.0.1
    depends_on:
      kafka1:
        condition: service_healthy
      schema-registry:
        condition: service_started
    ports:
      - "8082:8082"
    hostname: rest-proxy
    container_name: rest-proxy
    environment:
      KAFKA_REST_HOST_NAME: rest-proxy
      KAFKA_REST_BOOTSTRAP_SERVERS: "kafka1:9090"
      KAFKA_REST_LISTENERS: "http://0.0.0.0:8082"
      KAFKA_REST_SCHEMA_REGISTRY_URL: "http://schema-registry:8081"
      KAFKA_REST_CLIENT_SECURITY_PROTOCOL: SSL
      KAFKA_REST_CLIENT_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka.truststore.jks
      KAFKA_REST_CLIENT_SSL_TRUSTSTORE_PASSWORD: {{ general_vars.generic_psw }}
      KAFKA_REST_CLIENT_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/kafka.keystore.jks
      KAFKA_REST_CLIENT_SSL_KEYSTORE_PASSWORD: {{ general_vars.generic_psw }}
      KAFKA_REST_CLIENT_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""
    volumes:
      - "{{ general_vars.digital_twin_folder }}/certificates/keystore.jks:/etc/kafka/secrets/kafka.keystore.jks:ro"
      - "{{ general_vars.digital_twin_folder }}/certificates/truststore.jks:/etc/kafka/secrets/kafka.truststore.jks:ro"
    networks:
      - services-network

  # Kafka UI service
  kafka-ui:
    image: docker.io/kafbat/kafka-ui:main
    container_name: kafka-ui
    restart: always
    depends_on:
      kafka1:
        condition: service_healthy
    ports:
      - "9090:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: dt_links
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka1:9090
      KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL: SSL
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_TRUSTSTORE_LOCATION: /certs/kafka.truststore.jks
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_TRUSTSTORE_PASSWORD: {{ general_vars.generic_psw }}
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_KEYSTORE_LOCATION: /certs/kafka.keystore.jks
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_KEYSTORE_PASSWORD: {{ general_vars.generic_psw }}
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_KEY_PASSWORD: {{ general_vars.generic_psw }}
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://schema-registry:8081
      KAFKA_CLUSTERS_0_KSQLDBSERVER: http://ksqldb-server:8088

      SPRING_CONFIG_ADDITIONAL-LOCATION: /config.yml

    volumes:
      - "{{ general_vars.digital_twin_folder }}/kafka/kafka-ui-config.yml:/config.yml"
      - "{{ general_vars.digital_twin_folder }}/certificates/truststore.jks:/certs/kafka.truststore.jks:ro"
      - "{{ general_vars.digital_twin_folder }}/certificates/keystore.jks:/certs/kafka.keystore.jks:ro"
      - "{{ general_vars.digital_twin_folder }}/certificates/ca.der:/usr/local/share/ca-certificates/csc.der:ro"
    networks:
      - services-network

# Define named volumes
volumes:
  kafka-data1:
    driver: local

networks:
  services-network:
    external: true
    name: {{ general_vars.project_name }}-network

