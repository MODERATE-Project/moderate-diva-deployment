{$MACHINE_URL} {
	tls {$LETSENCRYPT_EMAIL}

	log {
		output stdout
		level INFO
	}

	respond "Certificate management initiated for {$MACHINE_URL}. If you see this, Caddy is running." 200
}

grafana.{$MACHINE_URL} {
	tls {$LETSENCRYPT_EMAIL}

	log {
		output stdout
		level INFO
	}

	reverse_proxy grafana:3000
}

reporter.{$MACHINE_URL} {
	tls {$LETSENCRYPT_EMAIL}

	log {
		output stdout
		level INFO
	}

	# Protect Quality Reporter API with basic auth; password is pre-hashed
	# NOTE: Basic Auth here is a temporary stopgap. For production deployments,
	# replace with proper integration with Keycloak/OAuth2/OIDC.
	basicauth {
		{$CADDY_BASIC_AUTH_USER} {$CADDY_BASIC_AUTH_PASSWORD_HASH}
	}

	reverse_proxy reporter:8000
}

keycloak.{$MACHINE_URL} {
	tls {$LETSENCRYPT_EMAIL}

	log {
		output stdout
		level INFO
	}

	reverse_proxy keycloak:8080
}

nifi.{$MACHINE_URL} {
	tls {$LETSENCRYPT_EMAIL}

	log {
		output stdout
		level INFO
	}

	# NiFi listens on HTTPS internally with a certificate issued for {$MACHINE_URL}
	# (no subdomain). Because Caddy terminates public TLS on nifi.{$MACHINE_URL},
	# we override the upstream Host header and TLS SNI to {$MACHINE_URL} so the
	# Jetty server accepts the request instead of returning "Invalid SNI".
	# The certificate does not currently match the public name, so we temporarily
	# disable upstream certificate verification. Once NiFi presents a cert that
	# includes nifi.{$MACHINE_URL}, remove tls_insecure_skip_verify and restore
	# the Host header/SNI to the public value.
	reverse_proxy https://nifi:8443 {
		header_up Host {$MACHINE_URL}
		header_up X-Forwarded-Proto https
		transport http {
			tls_insecure_skip_verify
			tls_server_name {$MACHINE_URL}
		}
	}
}

kafka.{$MACHINE_URL} {
	tls {$LETSENCRYPT_EMAIL}

	log {
		output stdout
		level INFO
	}

	reverse_proxy kafka-ui:8080
}

kafka-rest.{$MACHINE_URL} {
	tls {$LETSENCRYPT_EMAIL}

	log {
		output stdout
		level INFO
	}

	# Protect Kafka REST Proxy with basic auth; password is pre-hashed
	# NOTE: Basic Auth here is a temporary stopgap for protecting the Kafka REST Proxy.
	# For production deployments, this should be replaced with proper integration
	# with Keycloak/OAuth2/OIDC to secure the kafka-rest.{$MACHINE_URL} endpoint.
	basicauth {
		{$CADDY_BASIC_AUTH_USER} {$CADDY_BASIC_AUTH_PASSWORD_HASH}
	}

	reverse_proxy rest-proxy:8082
}
