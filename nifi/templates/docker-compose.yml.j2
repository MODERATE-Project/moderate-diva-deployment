name: {{ general_vars.project_name }}-nifi
services:
  nifi:
    image: docker.io/apache/nifi:2.6.0
    # Port mapping removed - NiFi accessed via Caddy reverse proxy
    # Internal HTTPS port 8443 available within Docker network
    volumes:
      - ../certificates:/opt/certs:ro
      - ./nifi/database_repository:/opt/nifi/nifi-current/database_repository
      - ./nifi/flowfile_repository:/opt/nifi/nifi-current/flowfile_repository
      - ./nifi/content_repository:/opt/nifi/nifi-current/content_repository
      - ./nifi/provenance_repository:/opt/nifi/nifi-current/provenance_repository
      - ./nifi/python_extensions:/opt/nifi/nifi-current/python_extensions
      - ./nifi/work:/opt/nifi/nifi-current/work
      - ./nifi/nar_extensions:/opt/nifi/nifi-current/nar_extensions
      - ./nifi/state:/opt/nifi/nifi-current/state
      - ./nifi/logs:/opt/nifi/nifi-current/logs
      - ./nifi.properties:/tmp/nifi.properties
      - nifi-lib:/opt/nifi/nifi-current/lib
    environment:
      - SINGLE_USER_CREDENTIALS_USERNAME={{ nifi_cred.nifi_user }}
      - SINGLE_USER_CREDENTIALS_PASSWORD={{ nifi_cred.nifi_psw }}
      - NIFI_WEB_HTTPS_HOST=0.0.0.0
      - NIFI_WEB_HTTPS_PORT=8443
      - NIFI_WEB_PROXY_HOST=nifi.{{ general_vars.machine_url }}
      - NIFI_SECURITY_KEYSTORE=/opt/certs/keystore.jks
      - NIFI_SECURITY_KEYSTORETYPE=JKS
      - NIFI_SECURITY_KEYSTOREPASSWD={{ general_vars.generic_psw }}
      - NIFI_SECURITY_KEYPASSWD={{ general_vars.generic_psw }}
      - NIFI_SECURITY_TRUSTSTORE=/opt/certs/truststore.jks
      - NIFI_SECURITY_TRUSTSTORETYPE=JKS
      - NIFI_SECURITY_TRUSTSTOREPASSWD={{ general_vars.generic_psw }}
      - NIFI_REMOTE_INPUT_SECURE=false
      - NIFI_CLUSTER_PROTOCOL_IS_SECURE=false
    networks:
      - services-network
volumes:
  nifi-lib:
networks:
  services-network:
    external: true
    name: {{ general_vars.project_name }}-network

